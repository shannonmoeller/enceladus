<!doctype html>
<title>Enceladus</title>

<script type="module">
	import {
		createContext,
		createViewport,
		clearContext,
		resizeContext,
		createTickLoop,
		constrainStick,
	} from './assets/js/vendor/game.js';

	const TAU = Math.PI * 2;
	const RELAX = 3;

	const canvas = document.querySelector('canvas');
	const ctx = createContext(canvas);

	const controller = { left: false, right: false };
	const player = { x: 0, x0: 0, y: 10, y0: 10, mass: 0 };
	const camera = { x: 0, y: 0, z: 1, mass: 1 };

	const loop = createTickLoop({
		update() {
			const { left, right } = controller;
			const { x, x0, y, y0 } = player;

			let vx = x - x0;
			let vy = y - y0;

			if (left) {
				vx -= 1;
				vy += 2;
			}

			if (right) {
				vx += 1;
				vy += 2;
			}

			vx *= 0.9;
			vy *= 0.9;

			player.x += vx;
			player.x0 = x;
			player.y += vy;
			player.y0 = y;

			for (let i = RELAX; i--;) {
				constrainStick(player, camera, {
					strength: 0.05,
				});
			}
		},

		render() {
			clearContext(ctx);

			const viewport = createViewport(ctx, {
				...camera,
				x: camera.x + 100,
				y: camera.y + 100,
			});

			ctx.beginPath();
			ctx.arc(player.x, player.y, 10, 0, TAU);
			ctx.fillStyle = 'black';
			ctx.fill();

			ctx.beginPath();
			ctx.arc(camera.x, camera.y, 5, 0, TAU);
			ctx.fillStyle = 'white';
			ctx.fill();

			viewport.restore();
		}
	});

	function resize() {
		resizeContext(ctx);

		camera.z = Math.min(
			ctx.width / 600,
			ctx.height / 400,
		);
	}

	addEventListener('resize', resize, { passive: true });

	document.addEventListener('keydown', (event) => {
		switch (event.key) {
			case 'ArrowLeft':
			case 'a':
				event.preventDefault();
				controller.left = true;
				break;
			case 'ArrowRight':
			case 'd':
				event.preventDefault();
				controller.right = true;
				break;
		}
	});

	document.addEventListener('keyup', (event) => {
		switch (event.key) {
			case 'ArrowLeft':
			case 'a':
				event.preventDefault();
				controller.left = false;
				break;
			case 'ArrowRight':
			case 'd':
				event.preventDefault();
				controller.right = false;
				break;
		}
	});

	resize(ctx);
	loop.start();
</script>

<style>
	html,
	body {
		margin: 0;
		overflow: hidden;
	}

	canvas {
		background: red;
		position: fixed;
		top: 0;
		left: 0;
		height: 100%;
		width: 100%;
	}
</style>

<canvas>
	<h1>Enceladus</h1>
</canvas>
